# ====================================================
#Growth_mortality_barplot Analysis

library(ggplot2)
library(data.table)
library(reshape2)
library(randomcoloR)
library(RColorBrewer)
library(scales)
library(ggprism)

# 读取数据
load("qSIP_res_freeze_total_corrected √.rdata")

# 提取数据
pop <- res$pop
pop[mortality>0,"mortality"] <- 0 #死亡速率为正值的数值设为0
tax_lev <- "Class"

# 合并每个处理门水平的生长和死亡速率，每个处理有3个重复，所以除以3
pop <- pop[!is.na(pop[[tax_lev]]), .(Growth=sum(growth)/3,Mortality=sum(mortality)/3),by=c("soil","protist",tax_lev)]

# 根据生长速率对物种排序
tax <- pop[,.(growth=sum(Growth)),by=tax_lev]
tax <- tax[order(tax$growth,decreasing = T),]
tax[[tax_lev]] <- gsub("^\\w__","",tax[[tax_lev]])

# 调整格式
data <- melt(pop,id.vars = c("soil","protist",tax_lev))
data$sub <- paste(data$soil,data$protist,sep = "_")
data$sub <- factor(data$sub,levels = c("B_P0","B_P2","R_P0","R_P2"))
data[[tax_lev]] <- gsub("^\\w__","",data[[tax_lev]])
data[[tax_lev]] <- factor(data[[tax_lev]],levels = tax[[tax_lev]])
names(data)[names(data)==tax_lev] <- "tax"

# 作图
set.seed(333) # Phylum用321，Class用333

p <- ggplot(data, aes(sub, value, fill = tax)) + 
  geom_col(position = 'stack', width = 0.8) + #调整柱子粗细
  facet_wrap(~variable, scales = 'free') +
  scale_fill_manual(values = c('#3877ae', '#f7c639', '#d2e6b7','#be354b', '#2D7B31', '#fabed4', '#2D3E8F', '#42A6DC', '#ffd8b1', '#B56539', '#c57bb0', '#E57F0E', '#8CC8AB', '#E65997', '#D11218', '#6D0555', '#df6045', '#EFE41B', '#591411', '#BBF9F6', '#7FB174', '#F0E68C', '#A3C1AD', '#E0B0FF', '#8B4513', '#FFC0CB', '#6A5ACD', '#708090', '#FFD700', '#4682B4', '#FF6347', '#48D1CC', '#FF69B4', '#9400D3', '#FF1493', '#00BFFF', '#FF4500', '#32CD32', '#FF8C00', '#20B2AA', '#87CEFA', '#778899', '#B0E0E6', '#FFA07A', '#40E0D0', '#FFDAB9', '#CD5C5C'))+
  labs(x = "Treatment", y = '16S rRNA gene copies/day') + #修改横纵坐标名
  theme_prism()+
  theme(axis.title = element_text(size=12.5),
        axis.text = element_text(size=11.5),
        strip.text = element_text(size=15),
  )
p

ggsave(p,filename = "growth_mortality_class.pdf",width = 12,height = 6)
# ggsave(p,filename = "growth_mortality_class_barplot.pdf",width = 15,height = 7)

# ====================================================
#Heatmap circle plot analysis

#黑土红壤分开，按显著性排序，取TOP50的family
# install.packages(c("tidyverse","patchwork","scales"))  # 如未安装
library(tidyverse)
library(patchwork)
library(scales)

# -------- 文件路径 & 输出 --------
file_p0 <- "R_D1_P0_2.txt"
file_p2 <- "R_D1_P2_2.txt"
out_pdf <- "heatmap_Family_Top50_by_significance.pdf"

# -------- 读入 --------
p0 <- readr::read_tsv(file_p0, show_col_types = FALSE)
p2 <- readr::read_tsv(file_p2, show_col_types = FALSE)

# 标准化 asv_id
if (!"asv_id" %in% names(p0)) names(p0)[1] <- "asv_id"
if (!"asv_id" %in% names(p2)) names(p2)[1] <- "asv_id"

# 必需的分类学列（至少 Phylum 与 Family）
tax_cols <- c("Phylum","Class","Order","Family","Genus","Species")
tax_cols <- tax_cols[tax_cols %in% names(p0)]
stopifnot(all(c("Phylum","Family") %in% tax_cols))

# 识别重复列（优先严格 P0_#/P2_#，否则任意包含 P0/P2）
rep_cols_p0 <- grep("P0_\\d+$", names(p0), value = TRUE); if (length(rep_cols_p0)==0) rep_cols_p0 <- grep("P0", names(p0), value = TRUE)
rep_cols_p2 <- grep("P2_\\d+$", names(p2), value = TRUE); if (length(rep_cols_p2)==0) rep_cols_p2 <- grep("P2", names(p2), value = TRUE)
rep_cols_p0 <- sort(rep_cols_p0); rep_cols_p2 <- sort(rep_cols_p2)
stopifnot(length(rep_cols_p0) > 0, length(rep_cols_p2) > 0)

# -------- 宽转长（带 treatment 标签）--------
long_p0 <- p0 %>%
  select(asv_id, all_of(tax_cols), all_of(rep_cols_p0)) %>%
  pivot_longer(all_of(rep_cols_p0), names_to = "replicate", values_to = "EAF") %>%
  mutate(treatment = "P0")

long_p2 <- p2 %>%
  select(asv_id, all_of(tax_cols), all_of(rep_cols_p2)) %>%
  pivot_longer(all_of(rep_cols_p2), names_to = "replicate", values_to = "EAF") %>%
  mutate(treatment = "P2")

long_all <- bind_rows(long_p0, long_p2) %>%
  mutate(EAF = suppressWarnings(as.numeric(EAF))) %>%
  replace_na(list(EAF = 0))

# ============================================================
# 显著性筛选：对每个 Family，用 Wilcoxon 检验 P0 vs P2（各3重复）
# ============================================================
# Family×replicate 的 EAF（每重复先把 ASV 求和）
fam_rep <- long_all %>%
  group_by(treatment, replicate, Family) %>%
  summarise(EAF = sum(EAF, na.rm = TRUE), .groups = "drop")

# 对每个 Family 计算 p 值 + 组内均值差（作次序兜底）
fam_stats <- fam_rep %>%
  group_by(Family) %>%
  summarise(
    pvalue = {
      x <- EAF[treatment == "P0"]
      y <- EAF[treatment == "P2"]
      if (length(x) == 0 || length(y) == 0) NA_real_
      else if (sd(c(x,y), na.rm = TRUE) == 0) 1
      else {
        p <- tryCatch(stats::wilcox.test(x, y, exact = FALSE)$p.value, error = function(e) NA_real_)
        if (is.na(p)) tryCatch(stats::t.test(x, y)$p.value, error = function(e) 1) else p
      }
    },
    mean_P0 = mean(EAF[treatment == "P0"], na.rm = TRUE),
    mean_P2 = mean(EAF[treatment == "P2"], na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(abs_diff = abs(mean_P2 - mean_P0)) %>%
  arrange(pvalue, desc(abs_diff))

# 选 Top50（不再用 n()；直接 head(50)）
family_keep <- fam_stats %>%
  filter(!is.na(pvalue)) %>%
  pull(Family) %>%
  unique() %>%
  head(50)

stopifnot(length(family_keep) > 0)

# ============================================================
# 构造绘图数据
# ============================================================
# 1) 热图：Family × replicate 的 EAF（P0+P2），仅保留 family_keep
heat_sum <- long_all %>%
  filter(Family %in% family_keep) %>%
  group_by(Phylum, Family, replicate) %>%
  summarise(EAF = sum(EAF, na.rm = TRUE), .groups = "drop")

# 2) 每个 Family 的代表 Phylum（多数出现）
phylum_map <- long_all %>%
  filter(Family %in% family_keep) %>%
  count(Family, Phylum, name = "n") %>%
  group_by(Family) %>%
  slice_max(n, n = 1, with_ties = FALSE) %>%
  ungroup() %>%
  transmute(
    Family = as.character(Family),
    Phylum_main = if_else(is.na(Phylum) | Phylum == "", "Unassigned", as.character(Phylum))
  )

# 3) 右侧 ASV 数（筛选集合内）
asv_count <- long_all %>%
  filter(Family %in% family_keep) %>%
  distinct(Family, asv_id) %>%
  count(Family, name = "ASV_n") %>%
  mutate(Family = as.character(Family))

# 4) 列顺序（6 列：P0在前，P2在后）
rep_levels <- c(rep_cols_p0, rep_cols_p2)

# 5) 行顺序：按 Phylum 分块，块内按 **P2 总 EAF** 降序（与之前规则一致）
order_by_p2 <- fam_rep %>%
  filter(Family %in% family_keep, treatment == "P2") %>%
  group_by(Family) %>%
  summarise(total_P2_EAF = sum(EAF), .groups = "drop")

family_order_df <- heat_sum %>%
  distinct(Family) %>%
  mutate(Family = as.character(Family)) %>%
  left_join(phylum_map, by = "Family") %>%
  left_join(order_by_p2, by = "Family") %>%
  mutate(
    Phylum_main   = if_else(is.na(Phylum_main) | Phylum_main == "", "Unassigned", Phylum_main),
    total_P2_EAF  = replace_na(total_P2_EAF, 0)
  ) %>%
  arrange(Phylum_main, desc(total_P2_EAF), Family)

# 让总量大的靠上（ggplot y 轴默认从下往上）
family_levels <- rev(family_order_df$Family)

# 6) 完整热图数据（补全 Family×replicate），并确保 Phylum_main 存在
heat_df <- tidyr::expand_grid(
  Family    = family_levels,
  replicate = rep_levels
) %>%
  left_join(heat_sum %>% mutate(Family = as.character(Family)), by = c("Family","replicate")) %>%
  mutate(EAF = replace_na(EAF, 0)) %>%
  left_join(phylum_map, by = "Family") %>%
  mutate(Phylum_main = if_else(is.na(Phylum_main) | Phylum_main == "", "Unassigned", Phylum_main)) %>%
  mutate(
    Family    = factor(Family,    levels = family_levels),
    replicate = factor(replicate, levels = rep_levels)
  )

# 7) 左/右文本数据（从 phylum_map 与 asv_count 构造，避免缺列）
left_text <- tibble(Family = factor(family_levels, levels = family_levels)) %>%
  mutate(Family_chr = as.character(Family)) %>%
  left_join(phylum_map, by = c("Family_chr" = "Family")) %>%
  mutate(Phylum_main = if_else(is.na(Phylum_main) | Phylum_main == "", "Unassigned", Phylum_main)) %>%
  group_by(Phylum_main) %>%
  mutate(phylum_label = if_else(row_number() == 1, Phylum_main, "")) %>%  # 门名写在组“第一行”（最上面）
  ungroup() %>%
  select(Family, phylum_label)

right_text <- tibble(Family = factor(family_levels, levels = family_levels)) %>%
  mutate(Family_chr = as.character(Family)) %>%
  left_join(asv_count, by = c("Family_chr" = "Family")) %>%
  mutate(ASV_n = replace_na(ASV_n, 0L)) %>%
  select(Family, ASV_n)

# ============================================================
# 作图（4色梯度：0 最浅）
# ============================================================
pal_EAF     <- c("#fef0d9","#fda269","#ed6541","#cc2f1c")
fill_limits <- c(0, max(heat_df$EAF, na.rm = TRUE))

# 左：Phylum 文本
p_left <- ggplot(left_text, aes(x = 1, y = Family, label = phylum_label)) +
  geom_text(hjust = 1) +
  scale_x_continuous(limits = c(0.5, 1.5), breaks = 1, labels = "Phylum") +
  labs(x = NULL, y = NULL) +
  theme_minimal(base_size = 11) +
  theme(
    axis.text.x = element_text(face = "bold"),
    axis.text.y = element_blank(),
    axis.ticks  = element_blank(),
    panel.grid  = element_blank()
  )

# 中：6 列热图
p_heat <- ggplot(heat_df, aes(x = replicate, y = Family, fill = EAF)) +
  geom_tile() +
  scale_fill_gradientn(colours = pal_EAF, limits = fill_limits, oob = squish, name = "EAF") +
  labs(x = NULL, y = NULL) +
  theme_minimal(base_size = 11) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
    axis.ticks  = element_blank(),
    panel.grid  = element_blank(),
    legend.position = "right"
  )

# 右：ASV 数
p_right <- ggplot(right_text, aes(x = 1, y = Family, label = ASV_n)) +
  geom_text(fontface = "bold", size = 3.3) +
  scale_x_continuous(limits = c(0.5, 1.5), breaks = 1, labels = "ASVs") +
  labs(x = NULL, y = NULL) +
  theme_minimal(base_size = 11) +
  theme(
    axis.text.x = element_text(face = "bold"),
    axis.text.y = element_blank(),
    axis.ticks  = element_blank(),
    panel.grid  = element_blank()
  )

final_plot <- p_left + p_heat + p_right + plot_layout(widths = c(2.4, 6, 1.4))

# 导出 PDF（矢量）
ok <- FALSE
try({
  ggsave(out_pdf, final_plot, width = 13, height = 10, units = "in", device = cairo_pdf)
  ok <- TRUE
}, silent = TRUE)
if (!ok) {
  ggsave(out_pdf, final_plot, width = 13, height = 10, units = "in", device = "pdf", useDingbats = FALSE)
}
message("Saved PDF: ", out_pdf)







##黑土红壤合并，筛选显著的ASV，按照科水平汇总后绘图，标记+-显著性
# ============================================================
# 同土壤内 P0 vs P2 的 t-test （α=0.05）筛 ASV → Family 汇总热图
# 右侧：B/R 显著性（+/-）与 ASV 数；左侧：Phylum 仅首行显示
# 显式使用 dplyr:: / tidyr:: 避免 select() 冲突
# ============================================================

# 建议只加载必要包，避免命名冲突
library(dplyr)
library(tidyr)
library(readr)
library(ggplot2)
library(patchwork)
library(scales)

# ---------- 文件路径 ----------
files <- list(
  B_P0 = "B_D1_P0_2.txt",
  B_P2 = "B_D1_P2_2.txt",
  R_P0 = "R_D1_P0_2.txt",
  R_P2 = "R_D1_P2_2.txt"
)

# ---------- 读取为长表（显式 dplyr::/tidyr::） ----------
read_and_pivot <- function(path, soil_tag, treat_tag){
  df <- readr::read_tsv(path, show_col_types = FALSE)
  
  # 统一列名：asv_id
  if (!("asv_id" %in% names(df))) names(df)[1] <- "asv_id"
  
  # 必要分类列
  need_tax <- c("Phylum","Family")
  if (!all(need_tax %in% names(df))) {
    stop(paste0("文件缺少必须的分类列 Phylum/Family: ", path))
  }
  
  # 识别该处理的重复列（尽量稳健）
  # 优先严格匹配，比如 P0_1 / P2_2；否则退化为包含 "P0"/"P2" 的列（不区分大小写）
  rep_cols <- grep(paste0("^", treat_tag, "(_\\d+)?$"), names(df), value = TRUE)
  if (length(rep_cols) == 0) {
    rep_cols <- names(df)[grepl(treat_tag, names(df), ignore.case = TRUE)]
  }
  rep_cols <- setdiff(rep_cols, c("asv_id","Phylum","Family"))
  if (length(rep_cols) == 0) {
    stop(paste0("未找到处理列: ", treat_tag, " in ", path))
  }
  
  df %>%
    dplyr::select(asv_id, Phylum, Family, all_of(rep_cols)) %>%
    tidyr::pivot_longer(all_of(rep_cols), names_to = "replicate", values_to = "EAF") %>%
    dplyr::mutate(
      EAF = suppressWarnings(as.numeric(EAF)),
      EAF = dplyr::coalesce(EAF, 0),
      Soil = soil_tag,
      Treatment = treat_tag
    )
}

long_all <- dplyr::bind_rows(
  read_and_pivot(files$B_P0, "B", "P0"),
  read_and_pivot(files$B_P2, "B", "P2"),
  read_and_pivot(files$R_P0, "R", "P0"),
  read_and_pivot(files$R_P2, "R", "P2")
) %>%
  dplyr::mutate(
    Family = trimws(as.character(Family)),
    Phylum = trimws(as.character(Phylum)),
    Family = dplyr::if_else(Family == "" | is.na(Family), "Unassigned", Family),
    Phylum = dplyr::if_else(Phylum == "" | is.na(Phylum), "Unassigned", Phylum)
  )

# ---------- ASV 层：同土壤内 P0 vs P2 的 t-test（3 vs 3） ----------
asv_rep <- long_all %>%
  dplyr::group_by(Soil, Treatment, replicate, asv_id, Phylum, Family) %>%
  dplyr::summarise(EAF = sum(EAF, na.rm = TRUE), .groups = "drop")

asv_sig <- asv_rep %>%
  dplyr::group_by(Soil, asv_id, Family, Phylum) %>%
  dplyr::summarise(
    mean_P0 = mean(EAF[Treatment == "P0"], na.rm = TRUE),
    mean_P2 = mean(EAF[Treatment == "P2"], na.rm = TRUE),
    p_value = {
      x <- EAF[Treatment == "P2"]
      y <- EAF[Treatment == "P0"]
      if (length(x) < 2 || length(y) < 2 || (stats::sd(x) == 0 && stats::sd(y) == 0)) 1
      else {
        pv <- tryCatch(stats::t.test(x, y, var.equal = FALSE)$p.value, error = function(e) NA_real_)
        ifelse(is.na(pv), 1, pv)
      }
    },
    .groups = "drop"
  ) %>%
  dplyr::filter(p_value < 0.05)

sel_asv <- asv_sig %>% dplyr::pull(asv_id) %>% unique()
stopifnot(length(sel_asv) > 0)

# ---------- Family 层：基于“显著 ASV 集”聚合 ----------
fam_rep <- asv_rep %>%
  dplyr::filter(asv_id %in% sel_asv) %>%
  dplyr::group_by(Soil, Treatment, replicate, Phylum, Family) %>%
  dplyr::summarise(EAF = sum(EAF, na.rm = TRUE), .groups = "drop")

# 用于热图显示的均值（每处理 3 重复的均值）
fam_mean <- fam_rep %>%
  dplyr::group_by(Soil, Treatment, Phylum, Family) %>%
  dplyr::summarise(EAF_mean = mean(EAF, na.rm = TRUE), .groups = "drop")

# 每个科包含的“显著 ASV 数”
asv_count <- asv_rep %>%
  dplyr::filter(asv_id %in% sel_asv) %>%
  dplyr::distinct(Family, asv_id) %>%
  dplyr::count(Family, name = "ASV_n")

# Family 层：同土壤内 P0 vs P2 的 t-test（用于 +/− 标注）
fam_sig <- fam_rep %>%
  dplyr::group_by(Soil, Family) %>%
  dplyr::summarise(
    mean_P0 = mean(EAF[Treatment == "P0"], na.rm = TRUE),
    mean_P2 = mean(EAF[Treatment == "P2"], na.rm = TRUE),
    p_value = {
      x <- EAF[Treatment == "P2"]
      y <- EAF[Treatment == "P0"]
      if (length(x) < 2 || length(y) < 2 || (stats::sd(x) == 0 && stats::sd(y) == 0)) 1
      else {
        pv <- tryCatch(stats::t.test(x, y, var.equal = FALSE)$p.value, error = function(e) NA_real_)
        ifelse(is.na(pv), 1, pv)
      }
    },
    sign_lab = dplyr::case_when(
      p_value < 0.05 & mean_P2 > mean_P0 ~ "+",
      p_value < 0.05 & mean_P2 < mean_P0 ~ "-",
      TRUE ~ ""
    ),
    .groups = "drop"
  )

# ---------- 热图数据（4 列：B_P0, B_P2, R_P0, R_P2） ----------
heat_mat <- fam_mean %>%
  dplyr::transmute(
    Family, Phylum,
    column = paste0(Soil, "_", Treatment),
    EAF = EAF_mean
  )

col_levels <- c("B_P0","B_P2","R_P0","R_P2")

families_all <- heat_mat %>% dplyr::pull(Family) %>% unique()

heat_df <- tidyr::expand_grid(
  Family = families_all,
  column = col_levels
) %>%
  dplyr::left_join(heat_mat, by = c("Family","column")) %>%
  dplyr::group_by(Family) %>%
  dplyr::mutate(
    Phylum = dplyr::if_else(all(is.na(Phylum)), "Unassigned",
                            Phylum[which(!is.na(Phylum))[1]])
  ) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(
    Family = trimws(as.character(Family)),
    Phylum = trimws(as.character(Phylum)),
    EAF    = dplyr::coalesce(EAF, 0)
  )

# 行排序：按 Phylum 分组，组内按 max(B_P2, R_P2) 降序（大的在上）
order_key <- heat_df %>%
  dplyr::filter(column %in% c("B_P2","R_P2")) %>%
  dplyr::group_by(Family, Phylum) %>%
  dplyr::summarise(score = max(EAF, na.rm = TRUE), .groups = "drop") %>%
  dplyr::arrange(Phylum, dplyr::desc(score), Family)

family_levels <- order_key$Family %>% rev() %>% unique()

heat_df <- heat_df %>%
  dplyr::mutate(
    Family = factor(Family, levels = family_levels),
    column = factor(column, levels = col_levels),
    Phylum = dplyr::if_else(Phylum == "" | is.na(Phylum), "Unassigned", Phylum)
  )

# 右侧显著性（B/R 两列）
right_sig <- tidyr::expand_grid(
  Family = family_levels,
  soil_col = c("B","R")
) %>%
  dplyr::mutate(Family_chr = as.character(Family)) %>%
  dplyr::left_join(
    fam_sig %>% dplyr::select(Soil, Family, sign_lab) %>%
      dplyr::mutate(Family = as.character(Family)),
    by = c("soil_col" = "Soil", "Family_chr" = "Family")
  ) %>%
  dplyr::transmute(Family, soil_col, label = dplyr::na_if(sign_lab, ""))

# 右侧 ASV 数
right_asv <- tibble::tibble(Family = family_levels) %>%
  dplyr::mutate(Family_chr = as.character(Family)) %>%
  dplyr::left_join(asv_count, by = c("Family_chr" = "Family")) %>%
  dplyr::mutate(ASV_n = dplyr::coalesce(ASV_n, 0L)) %>%
  dplyr::select(Family, ASV_n)

# 左侧 Phylum 文本（仅首行）
left_text <- heat_df %>%
  dplyr::distinct(Family, Phylum) %>%
  dplyr::arrange(Family) %>%
  dplyr::group_by(Phylum) %>%
  dplyr::mutate(phylum_label = dplyr::if_else(dplyr::row_number() == 1, as.character(Phylum), "")) %>%
  dplyr::ungroup() %>%
  dplyr::select(Family, phylum_label)

# ---------- 作图 ----------
pal_EAF <- c("#fef0d9","#fda269","#ed6541","#cc2f1c")
fill_limits <- c(0, max(heat_df$EAF, na.rm = TRUE))

p_left <- ggplot(left_text, aes(x = 1, y = Family, label = phylum_label)) +
  geom_text(hjust = 1) +
  scale_x_continuous(limits = c(0.5,1.5), breaks = 1, labels = "Phylum") +
  labs(x=NULL, y=NULL) +
  theme_minimal(base_size = 11) +
  theme(axis.text.y = element_blank(), axis.ticks=element_blank(),
        panel.grid = element_blank(), axis.text.x = element_text(face="bold"))

p_heat <- ggplot(heat_df, aes(x = column, y = Family)) +
  geom_tile(aes(fill = EAF), color = NA) +
  scale_fill_gradientn(colours = pal_EAF, limits = fill_limits, oob = scales::squish, name = "EAF") +
  labs(x=NULL, y=NULL) +
  theme_minimal(base_size = 11) +
  theme(axis.text.x = element_text(angle = 0, hjust = .5, vjust = 1),
        axis.ticks = element_blank(), panel.grid = element_blank(),
        legend.position = "right")

p_right_sig <- ggplot(right_sig, aes(x = soil_col, y = Family, label = label)) +
  geom_text(fontface = "bold", size = 3.6, na.rm = TRUE) +
  scale_x_discrete(labels = c("B","R")) +
  labs(x=NULL, y=NULL) +
  theme_minimal(base_size = 11) +
  theme(axis.text.x = element_text(face="bold"),
        axis.text.y = element_blank(), axis.ticks = element_blank(),
        panel.grid = element_blank())

p_right_asv <- ggplot(right_asv, aes(x = 1, y = Family, label = ASV_n)) +
  geom_text(fontface = "bold", size = 3.3) +
  scale_x_continuous(limits = c(0.5,1.5), breaks = 1, labels = "ASVs") +
  labs(x=NULL, y=NULL) +
  theme_minimal(base_size = 11) +
  theme(axis.text.x = element_text(face="bold"),
        axis.text.y = element_blank(), axis.ticks = element_blank(),
        panel.grid = element_blank())

final_plot <- p_left + p_heat + p_right_sig + p_right_asv +
  patchwork::plot_layout(widths = c(2.2, 8.2, 1.0, 1.2))

ggsave("heatmap_Family_sigASV_by_soil.pdf", final_plot,
       width = 11.5, height = 12, units = "in", device = cairo_pdf)

