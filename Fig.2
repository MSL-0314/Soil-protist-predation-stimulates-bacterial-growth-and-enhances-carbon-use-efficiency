# ====================================================
# Alpha Diversity Analysis

# Load required packages
library(picante)       # For phylogenetic diversity analysis
library(vegan)         # For ecological diversity indices

# Define alpha diversity calculation function
alpha <- function(x, tree = NULL, base = exp(1)) {
  # Calculate basic richness estimates
  est <- estimateR(x)
  
  # Extract diversity indices
  Richness <- est[1, ]
  Chao1 <- est[2, ]
  ACE <- est[4, ]
  
  # Calculate Shannon and Simpson indices
  Shannon <- diversity(x, index = 'shannon', base = base)
  Simpson <- diversity(x, index = 'simpson')    # Gini-Simpson index
  
  # Calculate Pielou's evenness
  Pielou <- Shannon / log(Richness, base)
  
  # Calculate Goods coverage
  goods_coverage <- 1 - rowSums(x == 1) / rowSums(x)
  
  # Combine results into a data frame
  result <- data.frame(
    Richness = Richness, 
    Shannon = Shannon, 
    Simpson = Simpson, 
    Pielou = Pielou, 
    Chao1 = Chao1, 
    ACE = ACE, 
    goods_coverage = goods_coverage
  )
  
  # Add phylogenetic diversity if tree is provided
  if (!is.null(tree)) {
    PD_whole_tree <- pd(x, tree, include.root = FALSE)[, 1]
    result$PD_whole_tree <- PD_whole_tree
  }
  
  return(result)
}

# ====================================================
# Main Analysis Section
# ====================================================

# Load OTU table and phylogenetic tree
# Note: Update file paths according to your actual data location

# Read OTU table
# Expected format: rows are OTUs/ASVs, columns are samples
otu <- read.delim('OTU_table_normalized.txt', 
                  row.names = 1, 
                  sep = '\t', 
                  stringsAsFactors = FALSE, 
                  check.names = FALSE)

# Transpose to make rows as samples and columns as OTUs (required format)
otu <- t(otu)

# Check data structure
cat("OTU table dimensions:", dim(otu), "\n")
cat("Samples:", nrow(otu), "\n")
cat("OTUs/ASVs:", ncol(otu), "\n")

# Read phylogenetic tree (if available)
# Note: Comment out if you don't have a phylogenetic tree
tree <- read.tree('bacteria_rooted_tree.nwk')

# ====================================================
# Calculate Alpha Diversity Indices
# ====================================================

cat("Calculating alpha diversity indices...\n")

# Option 1: Calculate without phylogenetic tree
# Using log base 2 for Shannon index
alpha_all <- alpha(otu, base = 2)

# Option 2: Calculate with phylogenetic tree (uncomment if tree is available)
# alpha_all <- alpha(otu, tree, base = 2)

# Display results summary
cat("\nAlpha Diversity Summary:\n")
cat("=======================\n")
print(summary(alpha_all))

# Display first few rows
cat("\nFirst 6 samples:\n")
print(head(alpha_all))

# ====================================================
# Save Results
# ====================================================

# Save alpha diversity table
output_file <- 'alpha_diversity_results.csv'
write.csv(alpha_all, output_file, quote = FALSE)
cat("\nResults saved to:", output_file, "\n")

# Optional: Save in multiple formats
# write.table(alpha_all, 'alpha_diversity_results.txt', sep = '\t', row.names = TRUE)
# saveRDS(alpha_all, 'alpha_diversity_results.rds')

# ====================================================
# Visualization (Optional)
# ====================================================

# Create a simple visualization of alpha diversity indices
if (require(ggplot2)) {
  library(ggplot2)
  library(tidyr)
  
  # Prepare data for visualization
  alpha_long <- alpha_all %>%
    mutate(Sample = rownames(alpha_all)) %>%
    pivot_longer(cols = -Sample, names_to = "Index", values_to = "Value")
  
  # Create boxplot
  p <- ggplot(alpha_long, aes(x = Index, y = Value, fill = Index)) +
    geom_boxplot(alpha = 0.7) +
    labs(title = "Alpha Diversity Indices Distribution",
         x = "Diversity Index",
         y = "Value") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position = "none")
  
  # Save plot
  ggsave("alpha_diversity_boxplot.pdf", p, width = 10, height = 6)
  cat("Visualization saved: alpha_diversity_boxplot.pdf\n")
}


# ====================================================
# PCoA Analysis
library(vegan)
library(ggplot2)
library(ade4)

# Read pre-calculated distance matrix file, e.g., Bray-Curtis distance
dis <- read.delim('bray_curtis_distance_matrix_D1.txt', row.names = 1, sep = '\t', stringsAsFactors = FALSE, check.names = FALSE)
bray_dis <- as.dist(dis)	# Convert to dist data type

# Correct negative values
is.euclid(bray_dis)  # Check if Euclidean distance, if FALSE then correct, if TRUE then proceed with ordination
bray_dis_sqrt <- sqrt(bray_dis)      # Square root transformation
is.euclid(bray_dis_sqrt)  # Check if Euclidean distance, should be TRUE

# PCoA function also provides correction parameters (add) to avoid negative eigenvalues
# Cailliez correction
# pcoa <- cmdscale(bray_dis, k = (nrow(otu) - 1), eig = TRUE, add = TRUE)

# PCoA ordination, see ?cmdscale for details
pcoa <- cmdscale(bray_dis, k = (nrow(dis) - 1), eig = TRUE)

# Eigenvalues of each PCoA axis
pcoa_eig <- pcoa$eig
# Evaluate negative eigenvalues (last few axes)
barplot(pcoa_eig)

# If negative eigenvalues have minimal impact, continue
# If negative eigenvalues are significant, correction should be applied first
# Variance explained by each PCoA axis
pcoa_exp <- pcoa$eig/sum(pcoa$eig)
# Variance explained for first 4 axes
pcoa1 <- paste('PCoA axis1:', round(100*pcoa_exp[1], 2), '%')
pcoa2 <- paste('PCoA axis2:', round(100*pcoa_exp[2], 2), '%')
pcoa3 <- paste('PCoA axis3:', round(100*pcoa_exp[3], 2), '%')
pcoa4 <- paste('PCoA axis4:', round(100*pcoa_exp[4], 2), '%')

# Add grouping information - Method 2
site <- data.frame(pcoa$point)[1:2]
site$name <- rownames(site)
group <- read.table("group_D1.txt", sep = "\t", header = T, row.names = 1)
group$name <- rownames(group)
nmds_dis_site <- merge(site, group, by = 'name')
nmds_dis_site$soil <- factor(nmds_dis_site$soil)
write.table(nmds_dis_site, file = 'Pcoa_D1.xls', sep = '\t', row.names = F)

# Plot 1 - Black soil_post-colonization
# size: point size, stroke: point border thickness, panel.grid.minor=element_blank() removes white gaps
p <- ggplot(data = nmds_dis_site, aes(X1, X2)) +
  geom_point(aes(color = soil, shape = protist), size = 4) +
  # scale_color_brewer(palette='Set1') +
  scale_color_manual(values = c("#3877AE", "#A31F24"), limits = c('B', 'R')) +
  scale_shape_manual(values = c(15, 19), limits = c('P0', 'P2')) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_rect(color = 'black', fill = 'transparent'), 
        plot.title = element_text(size = 15, hjust = 0.5),
        axis.title.y = element_text(size = 15),
        axis.title.x = element_text(size = 15),
        axis.text.x = element_text(size = 15, vjust = 0.5, hjust = 0.5),
        axis.text.y = element_text(size = 15, vjust = 0.5, hjust = 0.5),
        legend.text = element_text(size = 12),
        strip.text.x = element_text(size = 12)) +
  labs(x = pcoa1, y = pcoa2, title = 'Black soil_PCoA_P2_weighted-unifrac_distance') +
  stat_ellipse(aes(color = soil), geom = 'polygon', level = 0.95, alpha = 0, show.legend = FALSE, linetype = 2)

p 
ggsave(file = "D1.pdf", width = 9, height = 8)


# Plot 2 - Red soil_post-colonization
# size: point size, stroke: point border thickness, panel.grid.minor=element_blank() removes white gaps
p <- ggplot(data = nmds_dis_site, aes(X1, X2)) +
  geom_point(aes(color = protist, shape = bacterial), size = 2) +
  # scale_color_brewer(palette='Set1') +
  scale_color_manual(values = c('#9DC55C', '#D46115'), limits = c('P0', 'P2')) +
  scale_shape_manual(values = c(15, 17, 19), limits = c('D1', 'D2', 'D3')) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_rect(color = 'black', fill = 'transparent'), 
        plot.title = element_text(size = 15, hjust = 0.5),
        axis.title.y = element_text(size = 15),
        axis.title.x = element_text(size = 15),
        axis.text.x = element_text(size = 15, vjust = 0.5, hjust = 0.5),
        axis.text.y = element_text(size = 15, vjust = 0.5, hjust = 0.5),
        legend.text = element_text(size = 12),
        strip.text.x = element_text(size = 12)) +
  labs(x = pcoa1, y = pcoa2, title = 'Red soil_PCoA_P2_weighted-unifrac_distance') +
  stat_ellipse(aes(color = protist), geom = 'polygon', level = 0.95, alpha = 0, show.legend = FALSE, linetype = 2)

p 
# Adjust axis ranges
p + coord_cartesian(xlim = c(-0.23, 0.23), ylim = c(-0.23, 0.23))
# 5.5X8 inches

# Plot 2 alternative
# size: point size, stroke: point border thickness
p1 <- ggplot(data = nmds_dis_site, aes(X1, X2)) +
  geom_point(aes(color = treatment), size = 2) +
  # scale_color_brewer(palette='Paired') +
  scale_color_manual(values = c('#9DC55C', '#6AADDF', '#8B7AB0', '#F5B41F', '#E37831'), limits = c('S', 'R')) +
  theme(panel.grid.major = element_blank(), 
        panel.background = element_rect(color = 'black', fill = 'transparent'), 
        plot.title = element_text(hjust = 0.5)) +
  labs(x = pcoa1, y = pcoa2, title = 'Bacteria Black Soil Bray-Curtis PCoA') +
  stat_ellipse(aes(color = treatment), geom = 'polygon', level = 0.95, alpha = 0, show.legend = FALSE, linetype = 2)

p1 

# Adjust axis ranges
p1 + coord_cartesian(xlim = c(-0.27, 0.28), ylim = c(-0.27, 0.2))


# Plot 3
# size: point size, stroke: point border thickness
p <- ggplot(data = nmds_dis_site, aes(X1, X2)) +
  geom_point(aes(color = treatment, shape = soil.time, size = 0.15, stroke = 1.35)) +
  scale_color_brewer(palette = 'Set3') +
  scale_shape_manual(values = c(3, 15, 16, 17, 18, 4, 22, 21, 24, 23), 
                     limits = c('B0', 'B7', 'B14', 'B28', 'B56', 'R0', 'R7', 'R14', 'R28', 'R56')) +
  theme(panel.grid.major = element_blank(), 
        panel.background = element_rect(color = 'black', fill = 'transparent'), 
        plot.title = element_text(hjust = 0.5)) +
  labs(x = pcoa1, y = pcoa2, title = 'Protist Weighted Unifrac PCoA') 
p 
# Adjust axis ranges
p + coord_cartesian(ylim = c(-0.11, 0.29), xlim = c(-0.32, 0.33))



# Plot 1 - Combined soil plot
# size: point size, stroke: point border thickness, panel.grid.minor=element_blank() removes white gaps
p <- ggplot(data = nmds_dis_site, aes(X1, X2)) +
  geom_point(aes(color = soil, shape = protist), size = 2) +
  # scale_color_brewer(palette='Set1') +
  scale_color_manual(values = c("#00BCC2", "#F8766D")) +
  # scale_shape_manual(values = c(17,21,19,22,15),limits = c('0', '7', '14','28','56')) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        panel.background = element_rect(color = 'black', fill = 'transparent'), 
        plot.title = element_text(hjust = 0.5)) +
  labs(x = pcoa1, y = pcoa2, title = 'PCoA') +
  stat_ellipse(aes(color = soil), geom = 'polygon', level = 0.95, alpha = 0, show.legend = FALSE, linetype = 2)

p 


# ====================================================
# Richness calculation Analysis

# Display specific values directly
# ===== Packages =====
# install.packages(c("tidyverse","patchwork"))
library(tidyverse)
library(patchwork)

# ===== Read data =====
infile <- "richness_growth_calculate.csv"   # Replace with your file
df <- read.csv(infile, check.names = FALSE, stringsAsFactors = FALSE)
if ("phylum" %in% names(df)) df <- dplyr::rename(df, Phylum = phylum)

# Fix y-axis order (according to original table row order)
phylum_levels <- df$Phylum
fix_phylum_order <- function(d) d %>% mutate(Phylum = factor(Phylum, levels = phylum_levels))

# ===== Long format (soil / treatment / replicate) =====
long <- df %>%
  pivot_longer(cols = setdiff(names(df), "Phylum"),
               names_to = "cond", values_to = "value") %>%
  mutate(
    soil  = substr(cond, 1, 1),                          # B / R
    treat = stringr::str_extract(cond, "P0|P2"),         # P0 / P2
    rep   = stringr::str_replace(cond, "^[BR]_D1_P[02]_", "")
  ) %>%
  mutate(value = as.numeric(value)) %>%
  filter(treat %in% c("P0","P2")) %>%
  fix_phylum_order()

# ===== Statistics by Phylum x Soil =====
# Error bars: ±SE(diff), where SE(diff) = sqrt(sd(P2)^2/n2 + sd(P0)^2/n0)
# Significance: Welch t-test (two independent groups)
compute_stats <- function(d){
  x0 <- d$value[d$treat == "P0"]; n0 <- sum(!is.na(x0)); m0 <- mean(x0, na.rm = TRUE); s0 <- sd(x0, na.rm = TRUE)
  x2 <- d$value[d$treat == "P2"]; n2 <- sum(!is.na(x2)); m2 <- mean(x2, na.rm = TRUE); s2 <- sd(x2, na.rm = TRUE)
  
  diff   <- m2 - m0
  se_diff <- if (n0 >= 2 || n2 >= 2) sqrt((s0^2)/pmax(n0,1) + (s2^2)/pmax(n2,1)) else NA_real_
  
  pval <- NA_real_
  if (n0 >= 2 && n2 >= 2) {
    tt <- tryCatch(t.test(x2, x0, var.equal = FALSE), error = function(e) NULL)
    if (!is.null(tt)) pval <- tt$p.value
  }
  
  tibble(mean_P0 = m0, mean_P2 = m2, diff = diff,
         se = se_diff, xmin = diff - se_diff, xmax = diff + se_diff,
         p_value = pval)
}

stats <- long %>%
  group_by(Phylum, soil) %>%
  group_modify(~compute_stats(.x)) %>%
  ungroup() %>%
  fix_phylum_order() %>%
  mutate(sig = case_when(
    is.na(p_value)        ~ "",         # Non-significant and missing are not marked
    p_value <= 0.001      ~ "***",
    p_value <= 0.01       ~ "**",
    p_value <= 0.05       ~ "*",
    TRUE                  ~ ""
  ))

write.csv(stats %>% mutate(Phylum = as.character(Phylum)),
          "ttest_by_phylum_soil_SE.csv", row.names = FALSE)

# ===== Plotting (point = mean(P2)-mean(P0); errorbar = ±SE) =====
plot_one <- function(d, soil_title, fill_color){
  # Place asterisks outside error bars; if SE missing/0, place next to point
  pad <- 0.02 * diff(range(c(d$xmin, d$xmax, d$diff), na.rm = TRUE))
  d <- d %>%
    mutate(
      x_for_star = ifelse(is.na(se) | se == 0, diff,
                          ifelse(diff >= 0, xmax, xmin)),
      x_for_star = x_for_star + ifelse(diff >= 0, pad, -pad)
    )
  
  ggplot(d, aes(y = Phylum)) +
    geom_vline(xintercept = 0, linewidth = 1.2, colour = "#C69C3B") +
    geom_errorbarh(aes(xmin = xmin, xmax = xmax),
                   height = 0.2, linewidth = 0.6, colour = "grey35", na.rm = TRUE) +
    geom_point(aes(x = diff), size = 3.6, shape = 21,
               fill = fill_color, colour = "black", alpha = 0.95) +
    geom_text(data = subset(d, sig != ""),  # Only plot significant ones
              aes(x = x_for_star, label = sig),
              size = 3.2, fontface = "bold") +
    scale_y_discrete(limits = phylum_levels, drop = FALSE) +
    labs(title = soil_title,
         x = "Change in growing ASV richness (P2 − P0)",
         y = "Phylum\n(error bars = ±SE of difference)") +
    theme_classic(base_size = 12) +
    theme(axis.title.y = element_text(margin = margin(r = 10)),
          axis.title.x = element_text(margin = margin(t = 10)))
}

p_B <- stats %>% filter(soil == "B") %>% plot_one("Soil B", "#6B3F1F")
p_R <- stats %>% filter(soil == "R") %>% plot_one("Soil R", "#E0C89A")

# Display
print(p_B); print(p_R)

# ===== Save PDFs =====
ggsave("ASV_change_soil_B_SE.pdf", p_B, width = 6.5, height = 6, device = "pdf")
ggsave("ASV_change_soil_R_SE.pdf", p_R, width = 6.5, height = 6, device = "pdf")

combo <- p_B + p_R + plot_layout(ncol = 2)
ggsave("ASV_change_B_R_side_by_side_SE.pdf", combo, width = 13, height = 6, device = "pdf")



# Calculate percent change
library(tidyverse)
library(patchwork)

# ===== Read data =====
infile <- "richness_growth_calculate.csv"   # Replace with your file
df <- read.csv(infile, check.names = FALSE, stringsAsFactors = FALSE)
if ("phylum" %in% names(df)) df <- dplyr::rename(df, Phylum = phylum)

# Fix y-axis order according to original table
phylum_levels <- df$Phylum
fix_phylum_order <- function(d) d %>% mutate(Phylum = factor(Phylum, levels = phylum_levels))

# ===== Long format =====
long <- df %>%
  pivot_longer(cols = setdiff(names(df), "Phylum"),
               names_to = "cond", values_to = "value") %>%
  mutate(
    soil  = substr(cond, 1, 1),                    # B / R
    treat = stringr::str_extract(cond, "P0|P2")    # P0 / P2
  ) %>%
  mutate(value = as.numeric(value)) %>%
  filter(treat %in% c("P0","P2")) %>%
  fix_phylum_order()

# ===== Statistics: percent change + ±SE(%); Welch t-test for p =====
# If mean of P0 is 0, percent change cannot be calculated; default to NA.
# To avoid NA, set eps to a small value (e.g., 1), i.e., denominator = max(mean(P0), eps)
eps <- 0

compute_stats <- function(d){
  x0 <- d$value[d$treat == "P0"]; n0 <- sum(!is.na(x0)); m0 <- mean(x0, na.rm = TRUE); s0 <- sd(x0, na.rm = TRUE)
  x2 <- d$value[d$treat == "P2"]; n2 <- sum(!is.na(x2)); m2 <- mean(x2, na.rm = TRUE); s2 <- sd(x2, na.rm = TRUE)
  
  diff     <- m2 - m0
  se_diff  <- if (n0 >= 2 || n2 >= 2) sqrt((s0^2)/pmax(n0,1) + (s2^2)/pmax(n2,1)) else NA_real_
  
  # Percent change relative to P0 mean
  denom    <- if (m0 > 0 || eps > 0) max(m0, eps) else NA_real_
  diff_pct <- 100 * diff / denom
  se_pct   <- 100 * se_diff / denom
  xmin     <- diff_pct - se_pct
  xmax     <- diff_pct + se_pct
  
  # Welch t-test (significance independent of percent change, based on original values)
  pval <- NA_real_
  if (n0 >= 2 && n2 >= 2) {
    tt <- tryCatch(t.test(x2, x0, var.equal = FALSE), error = function(e) NULL)
    if (!is.null(tt)) pval <- tt$p.value
  }
  
  tibble(mean_P0 = m0, mean_P2 = m2,
         diff_pct = diff_pct, se_pct = se_pct, xmin = xmin, xmax = xmax,
         p_value = pval)
}

stats <- long %>%
  group_by(Phylum, soil) %>%
  group_modify(~compute_stats(.x)) %>%
  ungroup() %>%
  fix_phylum_order() %>%
  mutate(sig = case_when(
    is.na(p_value)        ~ "",
    p_value <= 0.001      ~ "***",
    p_value <= 0.01       ~ "**",
    p_value <= 0.05       ~ "*",
    TRUE                  ~ ""
  ))

write.csv(stats %>% mutate(Phylum = as.character(Phylum)),
          "ttest_by_phylum_soil_percent_SE.csv", row.names = FALSE)

# ===== Plotting (point = % change; errorbar = ±SE%) =====
plot_one <- function(d, soil_title, fill_color){
  # Place asterisks outside error bars; if SE missing/0, place next to point
  pad <- 0.02 * diff(range(c(d$xmin, d$xmax, d$diff_pct), na.rm = TRUE))
  d <- d %>%
    mutate(
      x_for_star = ifelse(is.na(se_pct) | se_pct == 0, diff_pct,
                          ifelse(diff_pct >= 0, xmax, xmin)),
      x_for_star = x_for_star + ifelse(diff_pct >= 0, pad, -pad)
    )
  
  ggplot(d, aes(y = Phylum)) +
    geom_vline(xintercept = 0, linewidth = 1.2, colour = "#C69C3B") +
    geom_errorbarh(aes(xmin = xmin, xmax = xmax),
                   height = 0.2, linewidth = 0.6, colour = "grey35", na.rm = TRUE) +
    geom_point(aes(x = diff_pct), size = 3.6, shape = 21,
               fill = fill_color, colour = "black", alpha = 0.95) +
    geom_text(data = subset(d, sig != ""),  # Only mark significant
              aes(x = x_for_star, label = sig),
              size = 3.2, fontface = "bold") +
    scale_y_discrete(limits = phylum_levels, drop = FALSE) +
    scale_x_continuous(labels = function(x) paste0(x, "%")) +
    labs(title = soil_title,
         x = "Percent change in growing ASV richness (relative to P0)",
         y = "Phylum\n(error bars = ±SE of percent change)") +
    theme_classic(base_size = 12) +
    theme(axis.title.y = element_text(margin = margin(r = 10)),
          axis.title.x = element_text(margin = margin(t = 10)))
}

p_B <- stats %>% filter(soil == "B") %>% plot_one("Soil B", "#6B3F1F")
p_R <- stats %>% filter(soil == "R") %>% plot_one("Soil R", "#E0C89A")

# Display
print(p_B); print(p_R)

# ===== Save PDFs =====
ggsave("ASV_percent_change_soil_B_SE.pdf", p_B, width = 6.5, height = 6, device = "pdf")
ggsave("ASV_percent_change_soil_R_SE.pdf", p_R, width = 6.5, height = 6, device = "pdf")

combo <- p_B + p_R + plot_layout(ncol = 2)
ggsave("ASV_percent_change_B_R.pdf", combo, width = 13, height = 6, device = "pdf")


# ===== After completing the statistics calculation for "absolute difference (P2 − P0)", add this section =====
# Ensure soil is ordered as B, R
stats <- stats %>% mutate(soil = factor(soil, levels = c("B","R")))

plot_combined_diff <- function(d){
  # Calculate position for asterisks (still placed outside error bars; if SE missing/0, place next to point)
  pad <- 0.02 * diff(range(c(d$xmin, d$xmax, d$diff), na.rm = TRUE))
  d <- d %>%
    mutate(
      x_for_star = ifelse(is.na(se) | se == 0, diff,
                          ifelse(diff >= 0, xmax, xmin)),
      x_for_star = x_for_star + ifelse(diff >= 0, pad, -pad)
    )
  
  pd <- position_dodge(width = 0.55)  # Arrange by soil along y-axis
  
  ggplot(d, aes(y = Phylum, group = soil)) +
    geom_vline(xintercept = 0, linewidth = 1.2, colour = "#C69C3B") +
    geom_errorbarh(aes(xmin = xmin, xmax = xmax, colour = soil),
                   height = 0.2, linewidth = 0.6, position = pd, na.rm = TRUE) +
    geom_point(aes(x = diff, fill = soil),
               size = 3.6, shape = 21, colour = "black", alpha = 0.95,
               position = pd) +
    geom_text(data = subset(d, sig != ""),
              aes(x = x_for_star, label = sig, colour = soil),
              size = 3.2, fontface = "bold", position = pd) +
    scale_y_discrete(limits = phylum_levels, drop = FALSE) +
    scale_colour_manual(values = c(B = "#6B3F1F", R = "#E0C89A"), name = "Soil") +
    scale_fill_manual(values   = c(B = "#6B3F1F", R = "#E0C89A"), name = "Soil") +
    labs(
      title = "Soil B & R (combined)",
      x = "Change in growing ASV richness (P2 − P0)",
      y = "Phylum\n(error bars = ±SE of difference)"
    ) +
    theme_classic(base_size = 12) +
    theme(
      legend.position = "right",
      axis.title.y = element_text(margin = margin(r = 10)),
      axis.title.x = element_text(margin = margin(t = 10))
    )
}

# Generate and save
p_combined_diff <- plot_combined_diff(stats)
print(p_combined_diff)
ggsave("ASV_change_B_R_combined_SE.pdf", p_combined_diff, width = 7.5, height = 6, device = "pdf")




# ====================================================
# T-test significance Analysis
library(reshape2)
library(ggplot2)
library(cowplot)
library(showtext)

# Read data and merge groups
alpha <- read.delim('richness.txt', header = T, row.names = 1, stringsAsFactors = FALSE, check.names = F)
alpha$sample_id <- row.names(alpha)
groupB <- read.delim('group_B_P2.txt', header = T, stringsAsFactors = FALSE, check.names = F)
groupR <- read.delim('group_R_P2.txt', header = T, stringsAsFactors = FALSE, check.names = F)
group <- rbind(groupB, groupR)

data <- merge(alpha, group, by = "sample_id")

# Initialize results dataframe with explicit column names
result <- data.frame(
  soil = character(),
  bacterial = character(),
  p = numeric(),
  p0_mean = numeric(),
  p2_mean = numeric(),
  mean_diff = numeric(),
  t_value = numeric(),
  label = character(),
  stringsAsFactors = FALSE
)

n = 0

# Process both B and R soils simultaneously
for (s in c("B", "R")) {
  for (t in unique(data$bacterial)) {
    n = n + 1
    data2 <- subset(data, soil == s & bacterial == t)
    
    # Check if protist has exactly two levels
    protist_levels <- unique(data2$protist)
    if (length(protist_levels) != 2) {
      result[n, "soil"] <- s
      result[n, "bacterial"] <- t
      result[n, "p"] <- NA
      result[n, "p0_mean"] <- NA
      result[n, "p2_mean"] <- NA
      result[n, "mean_diff"] <- NA
      result[n, "t_value"] <- NA
      result[n, "label"] <- paste("Number of groups =", length(protist_levels), sep="")
      next
    }
    
    # Check if sample size in each group is sufficient
    sample_counts <- table(data2$protist)
    if (any(sample_counts < 2)) {
      result[n, "soil"] <- s
      result[n, "bacterial"] <- t
      result[n, "p"] <- NA
      result[n, "p0_mean"] <- NA
      result[n, "p2_mean"] <- NA
      result[n, "mean_diff"] <- NA
      result[n, "t_value"] <- NA
      result[n, "label"] <- "Insufficient sample size"
      next
    }
    
    # Perform t-test
    t_test <- t.test(richness ~ protist, data = data2)
    p <- t_test$p.value
    
    # Calculate mean difference and other information
    p0_mean <- mean(data2$richness[data2$protist == "P0"], na.rm = TRUE)
    p2_mean <- mean(data2$richness[data2$protist == "P2"], na.rm = TRUE)
    mean_diff <- p0_mean - p2_mean
    
    result[n, "soil"] <- s
    result[n, "bacterial"] <- t
    result[n, "p"] <- p
    result[n, "p0_mean"] <- p0_mean
    result[n, "p2_mean"] <- p2_mean
    result[n, "mean_diff"] <- mean_diff
    result[n, "t_value"] <- t_test$statistic
    
    if (p < 0.001) { 
      result[n, "label"] <- "***"
    } else if (p < 0.01) {
      result[n, "label"] <- "**"
    } else if (p < 0.05) {
      result[n, "label"] <- "*"
    } else {
      result[n, "label"] <- "ns"
    }
  }
}

# View results
print("T-test results for evenness:")
print(result)

# Save results
write.csv(result, "eveness.csv", row.names = F, quote = F)

# Output significance summary
cat("\n=== Significance Summary ===\n")
for (s in c("B", "R")) {
  cat("\nSoil type:", s, "\n")
  for (t in c("D1", "D2", "D3")) {
    subset_result <- result[result$soil == s & result$bacterial == t, ]
    if (nrow(subset_result) > 0) {
      cat(t, ": P0 vs P2", subset_result$label, 
          "(p =", format(subset_result$p, scientific = TRUE, digits = 3), 
          ", diff =", round(subset_result$mean_diff, 4), ")\n")
    }
  }
}

# View results separately for each soil type
cat("\n=== Black Soil (B) Results ===\n")
print(result[result$soil == "B", ])

cat("\n=== Red Soil (R) Results ===\n")
print(result[result$soil == "R", ])
